# Just replace your "Deploy frontend to VPS" step with this:

      - name: Deploy frontend to VPS
        run: |
          rsync -avz --delete --exclude 'node_modules' --exclude '.git' ./ ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/home/nodepeers/htdocs/nodepeers.com/

          ssh -o ServerAliveInterval=60 -o ServerAliveCountMax=3 ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'EOF'
            cd /home/nodepeers/htdocs/nodepeers.com
            
            echo "=== Stopping all PM2 processes ==="
            pm2 kill 2>/dev/null || true
            pm2 flush 2>/dev/null || true
            
            echo "=== Cleaning previous build ==="
            rm -rf .next
            rm -rf node_modules/.cache
            
            echo "=== Installing dependencies ==="
            npm install
            
            echo "=== Building Next.js application ==="
            npm run build
            
            # Verify build
            if [ ! -f ".next/BUILD_ID" ]; then
              echo "ERROR: Build failed"
              exit 1
            fi
            
            echo "=== Starting PM2 process ==="
            pm2 delete nodepeers.com 2>/dev/null || true
            pm2 start npm --name "nodepeers.com" -- start
            pm2 save
            
            # Brief wait and status check
            sleep 3
            pm2 status
            
            echo "=== Deployment completed successfully ==="
            exit 0
          EOF